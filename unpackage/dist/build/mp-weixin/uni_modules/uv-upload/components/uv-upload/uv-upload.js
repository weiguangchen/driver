"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../uv-ui-tools/libs/function/test.js"),t=require("../../../uv-ui-tools/libs/mixin/mpMixin.js"),s=require("../../../uv-ui-tools/libs/mixin/mixin.js"),a=require("./utils.js"),o=require("./mixin.js"),l=require("./props.js"),n={name:"uv-upload",emits:["error","beforeRead","oversize","afterRead","delete","clickPreview"],mixins:[t.mpMixin,s.mixin,o.mixin_accept,l.props],data:()=>({lists:[],isInCount:!0}),watch:{fileList:{deep:!0,immediate:!0,handler(){this.formatFileList()}},deletable(e){e||this.lists.map((e=>{e.deletable=this.deletable}))}},methods:{formatFileList(){const{fileList:e=[],maxCount:t}=this,s=e.map((e=>Object.assign(Object.assign({},e),{isImage:"image"===this.accept||i.image(e.url||e.thumb),isVideo:"video"===this.accept||i.video(e.url||e.thumb),deletable:"boolean"==typeof e.deletable?e.deletable:this.deletable})));this.lists=s,this.isInCount=s.length<t},chooseFile(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{const{maxCount:e,multiple:t,lists:s,disabled:o}=this;if(o)return;let l;try{l=i.array(this.capture)?this.capture:this.capture.split(",")}catch(n){l=[]}a.chooseFile(Object.assign({accept:this.accept,multiple:this.multiple,capture:l,compressed:this.compressed,maxDuration:this.maxDuration,sizeType:this.sizeType,camera:this.camera},{maxCount:e-s.length})).then((e=>{this.onBeforeRead(t?e:e[0])})).catch((e=>{this.$emit("error",e)}))}),100)},onBeforeRead(e){const{beforeRead:t,useBeforeRead:s}=this;let a=!0;i.func(t)&&(a=t(e,this.getDetail())),s&&(a=new Promise(((i,t)=>{this.$emit("beforeRead",Object.assign(Object.assign({file:e},this.getDetail()),{callback:e=>{e?i():t()}}))}))),a&&(i.promise(a)?a.then((i=>this.onAfterRead(i||e))):this.onAfterRead(e))},getDetail(e){return{name:this.name,index:null==e?this.fileList.length:e}},onAfterRead(e){const{maxSize:i,afterRead:t}=this;(Array.isArray(e)?e.some((e=>e.size>i)):e.size>i)?this.$emit("oversize",Object.assign({file:e},this.getDetail())):("function"==typeof t&&t(e,this.getDetail()),this.$emit("afterRead",Object.assign({file:e},this.getDetail())))},deleteItem(e){this.$emit("delete",Object.assign(Object.assign({},this.getDetail(e)),{file:this.fileList[e]}))},onPreviewImage(t,s){const a=this.$uv.deepClone(this.lists);a.map(((e,i)=>{i==s&&(e.current=!0)}));const o=a.filter((e=>e.isImage)).findIndex((e=>e.current));this.onClickPreview(t,s),t.isImage&&this.previewFullImage&&e.index.previewImage({urls:this.lists.filter((e=>"image"===this.accept||i.image(e.url||e.thumb))).map((e=>e.url||e.thumb)),current:o,fail(){this.$uv.toast("预览图片失败")}})},onPreviewVideo(e,i){this.onClickPreview(e,i),this.previewFullVideo&&e.isVideo&&this.$refs.previewVideo.open(e.url)},onClickPreview(e,i){this.$emit("clickPreview",Object.assign(Object.assign({},e),this.getDetail(i)))}}};if(!Array){(e.resolveComponent("uv-icon")+e.resolveComponent("uv-loading-icon")+e.resolveComponent("uv-preview-video"))()}Math||((()=>"../../../uv-icon/components/uv-icon/uv-icon.js")+(()=>"../../../uv-loading-icon/components/uv-loading-icon/uv-loading-icon.js")+(()=>"../uv-preview-video/uv-preview-video.js"))();const r=e._export_sfc(n,[["render",function(i,t,s,a,o,l){return e.e({a:i.previewImage},i.previewImage?{b:e.f(o.lists,((t,s,a)=>e.e({a:t.isImage||t.type&&"image"===t.type},t.isImage||t.type&&"image"===t.type?{b:t.thumb||t.url,c:i.imageMode,d:e.o((e=>l.onPreviewImage(t,s)),s),e:e.s({width:i.$uv.addUnit(i.width),height:i.$uv.addUnit(i.height)})}:{f:"8c9da633-0-"+a,g:e.p({color:"#80CBF9",size:"26",name:t.isVideo||t.type&&"video"===t.type?"movie":"folder"}),h:e.t(t.isVideo||t.type&&"video"===t.type?"视频":"文件"),i:e.o((e=>l.onPreviewVideo(t,s)),s),j:e.s({width:i.$uv.addUnit(i.width),height:i.$uv.addUnit(i.height)})},{k:"uploading"===t.status||"failed"===t.status},"uploading"===t.status||"failed"===t.status?e.e({l:"failed"===t.status},"failed"===t.status?{m:"8c9da633-1-"+a,n:e.p({name:"close-circle",color:"#ffffff",size:"25"})}:{o:"8c9da633-2-"+a,p:e.p({size:"22",mode:"circle"})},{q:t.message},t.message?{r:e.t(t.message)}:{}):{},{s:"uploading"!==t.status&&(i.deletable||t.deletable)},"uploading"!==t.status&&(i.deletable||t.deletable)?{t:"8c9da633-3-"+a,v:e.p({name:"close",color:"#ffffff",size:"10"}),w:e.o((e=>l.deleteItem(s)),s)}:{},{x:"success"===t.status},"success"===t.status?{y:"8c9da633-4-"+a,z:e.p({name:"checkmark",color:"#ffffff",size:"12"})}:{},{A:s})))}:{},{c:o.isInCount},o.isInCount?e.e({d:e.p({name:i.uploadIcon,size:"26",color:i.uploadIconColor}),e:i.uploadText},i.uploadText?{f:e.t(i.uploadText)}:{},{g:i.disabled?"":"uv-upload__button--hover",h:e.o(((...e)=>l.chooseFile&&l.chooseFile(...e))),i:e.n(i.disabled&&"uv-upload__button--disabled"),j:e.s({width:i.$uv.addUnit(i.width),height:i.$uv.addUnit(i.height)}),k:e.o(((...e)=>l.chooseFile&&l.chooseFile(...e)))}):{},{l:e.sr("previewVideo","8c9da633-6"),m:e.s(i.$uv.addStyle(i.customStyle))})}],["__scopeId","data-v-8c9da633"]]);wx.createComponent(r);
