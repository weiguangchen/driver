"use strict";const e=require("../../../../common/vendor.js"),t=require("./props.js"),s=require("../../../uv-ui-tools/libs/mixin/mpMixin.js"),i=require("../../../uv-ui-tools/libs/mixin/mixin.js"),a=require("./qrcode.js"),o=require("./queue.js"),n=require("./cache.js");let r=null;const c={name:"uv-qrcode",mixins:[s.mpMixin,i.mixin,t.props],emits:["click","change","complete"],data:()=>({canvasId:"",canvas:void 0,canvasType:void 0,canvasContext:void 0,makeDelegate:void 0,drawDelegate:void 0,toTempFilePathDelegate:void 0,makeExecuted:!1,makeing:!1,drawing:!1,isError:!1,error:void 0,isH5Save:!1,tempFilePath:"",templateOptions:{size:0,width:0,height:0,canvasWidth:0,canvasHeight:0,canvasTransform:"",canvasDisplay:!1},uqrcodeOptions:{data:""},plugins:[],makeingPattern:[[[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]]]}),watch:{type:{handler(e){["2d"].includes(e)?this.canvasType=e:this.canvasType=void 0},immediate:!0},value:{handler(){this.auto&&this.remake()}},size:{handler(){this.auto&&this.remake()}},options:{handler(){this.auto&&this.remake()},deep:!0},makeing:{handler(e){e||"function"==typeof this.toTempFilePathDelegate&&this.toTempFilePathDelegate()}}},created(){this.canvasId=this.$uv.guid()},mounted(){this.templateOptions.size=this.$uv.getPx(this.size),this.templateOptions.width=this.templateOptions.size,this.templateOptions.height=this.templateOptions.size,this.templateOptions.canvasWidth=this.templateOptions.size,this.templateOptions.canvasHeight=this.templateOptions.size,"2d"==this.canvasType||(this.templateOptions.canvasTransform=`scale(${this.templateOptions.size/this.templateOptions.canvasWidth}, ${this.templateOptions.size/this.templateOptions.canvasHeight})`),this.start&&this.$nextTick((()=>{this.make()}))},methods:{getTemplateOptions(){var e=this.$uv.getPx(this.size);return l(this.templateOptions,{size:e,width:e,height:e})},getUqrcodeOptions(){return l(this.options,{data:String(this.value),size:Number(this.templateOptions.size)})},resetCanvas(e){this.templateOptions.canvasDisplay=!1,this.$nextTick((()=>{this.templateOptions.canvasDisplay=!0,this.$nextTick((()=>{e&&e()}))}))},async draw(t={},s=!1){if("function"!=typeof t.success&&(t.success=()=>{}),"function"!=typeof t.fail&&(t.fail=()=>{}),"function"!=typeof t.complete&&(t.complete=()=>{}),this.drawing){if(!s)return void(this.drawDelegate=()=>{this.draw(t,!0)})}else this.drawing=!0;if(!this.canvasId)return console.error("[uQRCode]: canvasId must be set!"),this.isError=!0,this.drawing=!1,t.fail({errMsg:"[uQRCode]: canvasId must be set!"}),void t.complete({errMsg:"[uQRCode]: canvasId must be set!"});if(!this.value)return console.error("[uQRCode]: value must be set!"),this.isError=!0,this.drawing=!1,t.fail({errMsg:"[uQRCode]: value must be set!"}),void t.complete({errMsg:"[uQRCode]: value must be set!"});this.templateOptions=this.getTemplateOptions(),this.uqrcodeOptions=this.getUqrcodeOptions(),"string"==typeof this.uqrcodeOptions.errorCorrectLevel&&(this.uqrcodeOptions.errorCorrectLevel=a.b.errorCorrectLevel[this.uqrcodeOptions.errorCorrectLevel]),void 0===this.options.useDynamicSize&&(this.uqrcodeOptions.useDynamicSize=!0);const i=r=new a.b;this.plugins.forEach((e=>i.register(e.plugin))),i.setOptions(this.uqrcodeOptions),i.make();let n=null;if("2d"===this.canvasType){const t=this.canvas=await new Promise((t=>{e.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).fields({node:!0,size:!0}).exec((e=>{t(e[0].node)}))}));n=this.canvasContext=t.getContext("2d"),this.templateOptions.canvasWidth=i.size,this.templateOptions.canvasHeight=i.size,this.templateOptions.canvasTransform="";const s=e.index.getSystemInfoSync().pixelRatio;t.width=i.dynamicSize*s,t.height=i.dynamicSize*s,n.scale(s,s),i.loadImage=this.getLoadImage((function(e){return new Promise(((s,i)=>{const a=t.createImage();a.src=e,a.onload=()=>{s(a)},a.onerror=e=>{i(e)}}))}))}else n=this.canvasContext=e.index.createCanvasContext(this.canvasId,this),this.templateOptions.canvasWidth=i.dynamicSize,this.templateOptions.canvasHeight=i.dynamicSize,this.templateOptions.canvasTransform=`scale(${this.templateOptions.size/this.templateOptions.canvasWidth}, ${this.templateOptions.size/this.templateOptions.canvasHeight})`,i.loadImage=this.getLoadImage((function(t){return new Promise(((s,i)=>{if(t.startsWith("http"))e.index.getImageInfo({src:t,success:e=>{s(e.path)},fail:e=>{i(e)}});else{if(t.startsWith("."))throw console.error("[uQRCode]: 本地图片路径仅支持绝对路径！"),new Error("[uQRCode]: local image path only supports absolute path!");s(t)}}))}));i.canvasContext=n,setTimeout((()=>{var e=this.plugins.find((e=>e.name==i.style)),s=e?e.drawCanvas:"drawCanvas";(this.queue?()=>o.queueDraw.exec((()=>i[s]())):()=>i[s]())().then((()=>{if(this.drawDelegate){let e=this.drawDelegate;this.drawDelegate=void 0,e()}else this.drawing=!1,t.success()})).catch((e=>{if(console.log(e),this.drawDelegate){let e=this.drawDelegate;this.drawDelegate=void 0,e()}else this.drawing=!1,this.isError=!0,t.fail(e)})).finally((()=>{t.complete()}))}),300)},make(e={}){this.makeExecuted=!0,this.makeing=!0,this.isError=!1,"function"!=typeof e.success&&(e.success=()=>{}),"function"!=typeof e.fail&&(e.fail=()=>{}),"function"!=typeof e.complete&&(e.complete=()=>{}),this.resetCanvas((()=>{clearTimeout(this.makeDelegate),this.makeDelegate=setTimeout((()=>{this.draw({success:()=>{setTimeout((()=>{e.success(),this.complete(!0)}),300)},fail:t=>{e.fail(t),this.error=t,this.complete(!1,t.errMsg)},complete:()=>{e.complete(),this.makeing=!1}})}),300)}))},remake(e){this.$emit("change"),this.make(e)},complete(e=!0,t=""){e?this.$emit("complete",{success:e}):this.$emit("complete",{success:e,errMsg:t})},toTempFilePath(t={}){if("function"!=typeof t.success&&(t.success=()=>{}),"function"!=typeof t.fail&&(t.fail=()=>{}),"function"!=typeof t.complete&&(t.complete=()=>{}),!this.makeExecuted){console.error("[uQRCode]: make() 方法从未调用！请先成功调用 make() 后再进行操作。");var s={errMsg:"[uQRCode]: make() method has never been executed! please execute make() successfully before operating."};return t.fail(s),void t.complete(s)}if(this.isError)return t.fail(this.error),void t.complete(this.error);if(this.makeing)this.toTempFilePathDelegate=()=>{this.toTempFilePath(t)};else if(this.toTempFilePathDelegate=null,"2d"===this.canvasType)try{let s=null;s=e.toRaw(this.canvas).toDataURL(),t.success({tempFilePath:s}),t.complete({tempFilePath:s})}catch(i){t.fail(i),t.complete(i)}else e.index.canvasToTempFilePath({canvasId:this.canvasId,fileType:this.fileType,width:Number(this.templateOptions.canvasWidth),height:Number(this.templateOptions.canvasHeight),destWidth:Number(this.templateOptions.size),destHeight:Number(this.templateOptions.size),success:e=>{t.success(e)},fail:e=>{t.fail(e)},complete:()=>{t.complete()}},this)},save(t={}){"function"!=typeof t.success&&(t.success=()=>{}),"function"!=typeof t.fail&&(t.fail=()=>{}),"function"!=typeof t.complete&&(t.complete=()=>{}),this.toTempFilePath({success:s=>{if("2d"===this.canvasType){const i=new RegExp("^data:image/png;base64,","g"),a=s.tempFilePath.replace(i,""),o=e.wx$1.getFileSystemManager(),n=`${e.wx$1.env.USER_DATA_PATH}/${(new Date).getTime()}${Math.random().toString().split(".")[1]}.png`;o.writeFile({filePath:n,data:a,encoding:"base64",success:s=>{e.index.saveImageToPhotosAlbum({filePath:n,success:e=>{t.success(e)},fail:e=>{t.fail(e)},complete:()=>{t.complete()}})},fail:e=>{t.fail(e)},complete:()=>{t.complete()}})}else e.index.saveImageToPhotosAlbum({filePath:s.tempFilePath,success:e=>{t.success(e)},fail:e=>{t.fail(e)},complete:()=>{t.complete()}})},fail:e=>{t.fail(e),t.complete(e)}})},onClick(e){this.$emit("click",e)},getInstance:()=>r,registerStyle(e){if("style"!=e.Type)return console.warn("[uQRCode]: registerStyle 仅支持注册 style 类型的扩展！"),{errMsg:"registerStyle 仅支持注册 style 类型的扩展！"};"function"==typeof e&&this.plugins.push({plugin:e,name:e.Name,drawCanvas:e.DrawCanvas})},getLoadImage(e){var t=this;return"function"==typeof e?function(s){return t.isQueueLoadImage?o.queueLoadImage.exec((()=>new Promise(((t,i)=>{setTimeout((()=>{const a=n.cacheImageList.find((e=>e.src==s));a?t(a.img):e(s).then((e=>{n.cacheImageList.push({src:s,img:e}),t(e)})).catch((e=>{i(e)}))}),10)})))):e(s)}:function(e){return Promise.resolve(e)}}}};function l(e={},t={},s=!1){let i;i=s?e:{...e};for(let o in t){var a=t[o];null!=a&&(a.constructor==Object?i[o]=this.deepReplace(i[o],a):a.constructor!=String||a?i[o]=a:i[o]=i[o])}return i}const p=e._export_sfc(c,[["render",function(t,s,i,a,o,n){return e.e({a:o.templateOptions.canvasDisplay},o.templateOptions.canvasDisplay?{b:o.canvasId,c:o.canvasId,d:o.canvasType,e:`${o.templateOptions.canvasWidth}px`,f:`${o.templateOptions.canvasHeight}px`,g:o.templateOptions.canvasTransform,h:e.o(((...e)=>n.onClick&&n.onClick(...e)))}:{},{i:void 0!==t.loading&&t.loading?t.loading:o.makeing},(void 0!==t.loading&&t.loading?t.loading:o.makeing)?{j:o.templateOptions.size/4+"px",k:o.templateOptions.size/4+"px"}:{},{l:o.isError},o.isError?{m:e.t(o.error.errMsg),n:e.r("error",{error:o.error}),o:e.o(((...e)=>n.onClick&&n.onClick(...e)))}:{},{p:t.hide?1:"",q:`${o.templateOptions.width}px`,r:`${o.templateOptions.height}px`})}],["__scopeId","data-v-c3c677b5"]]);wx.createComponent(p);
